name: Deploy to Vercel

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    name: Build and deploy to Vercel
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Detect project and dist outputPath
        id: detect
        run: |
          node -e "const fs=require('fs'); const a=JSON.parse(fs.readFileSync('angular.json','utf8')); const projects=Object.keys(a.projects||{}); const defaultP=a.defaultProject||projects[0]||''; const p=defaultP||projects[0]||''; let out=''; if(p && a.projects && (a.projects[p].architect || a.projects[p].targets)){ const buildConf=(a.projects[p].architect&&a.projects[p].architect.build)?a.projects[p].architect.build:(a.projects[p].targets?a.projects[p].targets.build:undefined); if(buildConf && buildConf.options && buildConf.options.outputPath) out=buildConf.options.outputPath; }
          if(!out) out=(p?('dist/'+p):'dist'); console.log('project='+p); console.log('out='+out); fs.writeFileSync(process.env.GITHUB_ENV, 'PROJECT='+p+'\nOUT='+out+'\n');"

      - name: Check VERCEL_TOKEN secret
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then echo "ERROR: VERCEL_TOKEN secret is not set. Add it in Settings → Secrets → Actions → VERCEL_TOKEN" && exit 1; fi

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Build production bundle
        env:
          OUT: ${{ env.OUT }}
        run: |
          npx ng build --configuration production --output-path "$OUT"

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_SCOPE: ${{ secrets.VERCEL_SCOPE }}
          VERCEL_PROJECT_NAME: ${{ secrets.VERCEL_PROJECT_NAME }}
        run: |
          DIST="$OUT"
          ARGS=""
          if [ -n "$VERCEL_SCOPE" ]; then ARGS="$ARGS --scope $VERCEL_SCOPE"; fi
          if [ -n "$VERCEL_PROJECT_NAME" ]; then ARGS="$ARGS --name $VERCEL_PROJECT_NAME"; fi
          echo "Running: npx vercel --prod --token **** --confirm $ARGS $DIST"
          npx vercel --prod --token "$VERCEL_TOKEN" --confirm $ARGS "$DIST"
