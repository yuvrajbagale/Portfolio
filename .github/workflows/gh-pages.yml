name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    name: Build and publish to GitHub Pages
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Detect project and dist outputPath
        id: detect
        run: |
          node -e "const fs=require('fs'); const a=JSON.parse(fs.readFileSync('angular.json','utf8')); const projects=Object.keys(a.projects||{}); const defaultP=a.defaultProject||projects[0]||''; const p=defaultP||projects[0]||''; let out=''; if(p && a.projects && (a.projects[p].architect || a.projects[p].targets)){ const buildConf=(a.projects[p].architect&&a.projects[p].architect.build)?a.projects[p].architect.build:(a.projects[p].targets?a.projects[p].targets.build:undefined); if(buildConf && buildConf.options && buildConf.options.outputPath) out=buildConf.options.outputPath; }
          if(!out) out=(p?('dist/'+p):'dist'); const repo=process.env.GITHUB_REPOSITORY.split('/')[1]; const isUserOrOrg = repo.endsWith('.github.io') ? 'true' : 'false'; console.log('project='+p); console.log('out='+out); console.log('isUserOrOrg='+isUserOrOrg); fs.writeFileSync(process.env.GITHUB_ENV, 'PROJECT='+p+'\nOUT='+out+'\nIS_USER_OR_ORG='+isUserOrOrg+'\n');"

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Build production bundle
        env:
          OUT: ${{ env.OUT }}
          IS_USER_OR_ORG: ${{ env.IS_USER_OR_ORG }}
          REPO_NAME: ${{ github.repository }}
        run: |
          # compute base-href: if a user/org site (repo name ends with .github.io) use /, else use /<repo>/
          REPO_SHORT=$(echo "$REPO" | cut -d'/' -f2)
          if [ "${IS_USER_OR_ORG}" = "true" ]; then BASE_HREF="/"; else BASE_HREF="/${REPO_SHORT}/"; fi
          echo "Using base-href: $BASE_HREF"
          npx ng build --configuration production --output-path "$OUT" --base-href "$BASE_HREF"

      - name: Ensure repo docs (publish dir) exists
        run: |
          echo "Publish dir: $OUT"

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.OUT }}
          # default publish_branch is gh-pages; change to 'docs' if you prefer that
          publish_branch: gh-pages
